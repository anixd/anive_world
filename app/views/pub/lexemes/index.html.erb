<% content_for :title, "#{@language.name} Dictionary" %>

<%= render 'pub/shared/search_block' %>

<div class="bg-white p-6 rounded-lg shadow-md">
  <div class="mb-6">
    <%= render 'pub/shared/breadcrumbs', crumbs: [
      { title: "Languages", path: pub_languages_path },
      { title: @language.name, path: pub_language_path(@language) },
      { title: "Dictionary" }
    ] %>
  </div>

  <div class="border-b pb-4 mb-6">
    <h1 class="text-3xl font-bold"><%= @language.name %> Dictionary</h1>
    <p class="mt-1 text-gray-600"><%= link_to "← Back to all languages", pub_languages_path, class: "text-blue-600 hover:underline" %></p>
  </div>

  <div class="mb-6 p-4 bg-gray-50 border rounded-lg">
    <details class="group" <%= 'open' if params[:pos].present? %>>
      <summary class="list-none flex items-center justify-between p-2 cursor-pointer font-semibold text-gray-800 text-sm hover:bg-gray-100 rounded-lg">
        <div class="flex items-center gap-4">
          <span>Filters</span>
          <% if params[:pos].present? %>
            <%= link_to "Reset Filters", pub_language_lexemes_path(@language), class: "text-md font-bold text-red-600 hover:underline border rounded-sm px-1" %>
            <span class="font-mono text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-md">[<%= @pagy.count %>]</span>
          <% end %>
        </div>
        <span class="transition group-open:rotate-90">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg>
      </span>
      </summary>
      <div class="mt-4 pt-4 border-t">
        <%= form_with url: pub_language_lexemes_path(@language), method: :get, data: { controller: "autosubmit" } do |form| %>
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            <% @parts_of_speech.each do |pos| %>
              <label class="flex items-center space-x-2">
                <%= check_box_tag "pos[]", pos.code, Array(params[:pos]).include?(pos.code),
                                  class: "h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500",
                                  data: { action: "change->autosubmit#submit" } %>
                <span class="text-sm"><%= pos.name %></span>
              </label>
            <% end %>
          </div>
        <% end %>
      </div>
    </details>
  </div>

  <div class="my-4">
    <%= render "shared/pagination_controls", pagy: @pagy %>
  </div>

  <% if @lexemes.any? %>
    <div class="flex flex-col gap-3">
      <% @lexemes.each do |lexeme| %>
        <% first_word = lexeme.words.first %>
        <%= link_to pub_language_lexeme_path(@language, lexeme), class: "block p-4 bg-white shadow rounded-lg border hover:border-blue-400 group" do %>
          <h2 class="text-2xl font-semibold text-blue-700 group-hover:underline">
            <%= lexeme.spelling %>
          </h2>
          <% if first_word %>
            <div class="flex items-baseline gap-4 mt-1 text-sm">
              <% if first_word.transcription.present? %>
                <p class="text-gray-500">[<%= first_word.transcription %>]</p>
              <% end %>
              <% if first_word.parts_of_speech.any? %>
                <p class="font-semibold text-gray-600"><%= first_word.parts_of_speech.map(&:name).join(', ') %></p>
              <% end %>
            </div>
            <div class="prose prose-sm max-w-none text-gray-800 mt-2">
              <%= render_markdown(first_word.definition) %>
            </div>
          <% end %>
        <% end %>
      <% end %>
    </div>

    <div class="mt-8">
      <%= render "shared/pagination_controls", pagy: @pagy %>
    </div>
  <% else %>
    <p class="text-gray-500 italic">There are no published words in this dictionary yet.</p>
  <% end %>
</div>
